# Avaliação do Risco de Extinção

- Para que um táxon seja incluído em qualquer uma das categorias de ameaça, basta que atenda a um dos critérios. No entanto, ele deve ser avaliado em relação a todos os critérios possíveis, de acordo com a disponibilidade de dados, e a listagem deve indicar todos os critérios aplicáveis à categoria de ameaça mais elevada.

- Apenas os critérios relativos à categoria mais alta de ameaça para a qual o táxon se qualifica devem ser listados.
    - Por exemplo, se um táxon atende aos critérios $A$, $C$ e $D$ nas categorias `VU` e `EN`, e apenas ao critério $A$ na categoria `CR`, então somente o critério $A$, atendido na categoria `CR`, deve ser listado, por se tratar da categoria mais elevada de ameaça.
        - Ainda assim, recomenda-se que os avaliadores documentem também os critérios sob os quais o táxon se enquadra em categorias de menor ameaça, pois essas informações são fundamentais para o planejamento de ações de conservação e recuperação da espécie.

## Diretrizes para Documentação de Ameaça

Os critérios têm como objetivo detectar sintomas de risco, e não suas causas [@Mace2008]. Em outras palavras, buscam identificar os padrões das ameaças, independentemente dos processos que deram origem a esses padrões objetivos.

Os critérios são aplicáveis a qualquer processo de ameaça que resulte em sintomas como declínio populacional, tamanhos populacionais pequenos e pequenas distribuições geográficas.

**Vide abaixo o esquema de classificação das ameaças da IUCN:**

:::{.callout-note collapse="true"}

## *Threats Classification Scheme*

- 1 **Residential & commercial development**
    - 1.1 Housing & urban areas
    - 1.2 Commercial & industrial areas
    - 1.3 Tourism & recreation areas
 
- **2 Agriculture & aquaculture**
    - 2.1 Annual & perennial non-timber crops
        - 2.1.1 Shifting agriculture
        - 2.1.2 Small-holder farming
        - 2.1.3 Agro-industry farming
        - 2.1.4 Scale Unknown/Unrecorded
    - 2.2 Wood & pulp plantations
        - 2.2.1 Small-holder plantations
        - 2.2.2 Agro-industry plantations
        - 2.2.3 Scale Unknown/Unrecorded
    - 2.3 Livestock farming & ranching
        - 2.3.1 Nomadic grazing
        - 2.3.2 Small-holder grazing, ranching or farming
        - 2.3.3 Agro-industry grazing, ranching or farming
        - 2.3.4 Scale Unknown/Unrecorded
    - 2.4 Marine & freshwater aquaculture
        - 2.4.1 Subsistence/artisanal aquaculture
        - 2.4.2 Industrial aquaculture
        - 2.4.3 Scale Unknown/Unrecorded
 
- **3 Energy production & mining**
    - 3.1 Oil & gas drilling
    - 3.2 Mining & quarrying
    - 3.3 Renewable energy
 
- **4 Transportation & service corridors**
    - 4.1 Roads & railroads
    - 4.2 Utility & service lines
    - 4.3 Shipping lanes
    - 4.4 Flight paths
 
- **5 Biological resource use**
    - 5.1 Hunting & collecting terrestrial animals
        - 5.1.1 Intentional use (species being assessed is the target)
        - 5.1.2 Unintentional effects (species being assessed is not the target)
        - 5.1.3 Persecution/control
        - 5.1.4 Motivation Unknown/Unrecorded
    - 5.2 Gathering terrestrial plants
        - 5.2.1 Intentional use (species being assessed is the target)
        - 5.2.2 Unintentional effects (species being assessed is not the target)
        - 5.2.3 Persecution/control
        - 5.2.4 Motivation Unknown/Unrecorded
    - 5.3 Logging & wood harvesting
        - 5.3.1 Intentional use: subsistence/small scale (species being assessed is the target [harvest]
        - 5.3.2 Intentional use: large scale (species being assessed is the target)[harvest]
        - 5.3.3 Unintentional effects: subsistence/small scale (species being assessed is not the target)[harvest]
        - 5.3.4 Unintentional effects: large scale (species being assessed is not the target)[harvest]
        - 5.3.5 Motivation Unknown/Unrecorded
        - 5.4 Fishing & harvesting aquatic resources
        - 5.4.1 Intentional use: subsistence/small scale (species being assessed is the target)[harvest]
        - 5.4.2 Intentional use: large scale (species being assessed is the target)[harvest]
        - 5.4.3 Unintentional effects: subsistence/small scale (species being assessed is not the target)[harvest]
        - 5.4.4 Unintentional effects: large scale (species being assessed is not the target)[harvest]
        - 5.4.5 Persecution/control
        - 5.4.6 Motivation Unknown/Unrecorded
 
- **6 Human intrusions & disturbance**
    - 6.1 Recreational activities
    - 6.2 War, civil unrest & military exercises
    - 6.3 Work & other activities
 
- **7 Natural system modifications**
    - 7.1 Fire & fire suppression
        - 7.1.1 Increase in fire frequency/intensity
        - 7.1.2 Suppression in fire frequency/intensity
        - 7.1.3 Trend Unknown/Unrecorded
    - 7.2 Dams & water management/use
        - 7.2.1 Abstraction of surface water (domestic use)
        - 7.2.2 Abstraction of surface water (commercial use)
        - 7.2.3 Abstraction of surface water (agricultural use)
        - 7.2.4 Abstraction of surface water (unknown use)
        - 7.2.5 Abstraction of ground water (domestic use)
        - 7.2.6 Abstraction of ground water (commercial use)
        - 7.2.7 Abstraction of ground water (agricultural use)
        - 7.2.8 Abstraction of ground water (unknown use)
        - 7.2.9 Small dams
        - 7.2.10 Large dams
        - 7.2.11 Dams (size unknown)
    - 7.3 Other ecosystem modifications
 
- **8 Invasive & other problematic species, genes & diseases**
    - 8.1 Invasive non-native/alien species/diseases
        - 8.1.1 Unspecified species
        - 8.1.2 Named species
    - 8.2 Problematic native species/diseases
        - 8.2.1 Unspecified species
        - 8.2.2 Named species
    - 8.3 Introduced genetic material
    - 8.4 Problematic species/diseases of unknown origin
        - 8.4.1 Unspecified species
        - 8.4.2 Named species
    - 8.5 Viral/prion-induced diseases
        - 8.5.1 Unspecified "species" (disease)
        - 8.5.2 Named "species" (disease)
    - 8.6 Diseases of unknown cause 
 
- **9 Pollution**
    - 9.1 Domestic & urban waste water
        - 9.1.1 Sewage
        - 9.1.2 Run-off
        - 9.1.3 Type Unknown/Unrecorded
    - 9.2 Industrial & military effluents
        - 9.2.1 Oil spills
        - 9.2.2 Seepage from mining
        - 9.2.3 Type Unknown/Unrecorded
    - 9.3 Agricultural & forestry effluents
        - 9.3.1 Nutrient loads
        - 9.3.2 Soil erosion, sedimentation
        - 9.3.3 Herbicides & pesticides
        - 9.3.4 Type Unknown/Unrecorded
    - 9.4 Garbage & solid waste
    - 9.5 Air-borne pollutants
        - 9.5.1 Acid rain
        - 9.5.2 Smog
        - 9.5.3 Ozone
        - 9.5.4 Type Unknown/Unrecorded
    - 9.6 Excess energy
        - 9.6.1 Light pollution
        - 9.6.2 Thermal pollution
        - 9.6.3 Noise pollution
        - 9.6.4 Type Unknown/Unrecorded
 
- **10 Geological events**
    - 10.1 Volcanoes
    - 10.2 Earthquakes/tsunamis
    - 10.3 Avalanches/landslides
 
- **11 Climate change & severe weather**
    - 11.1 Habitat shifting & alteration
    - 11.2 Droughts
    - 11.3 Temperature extremes
    - 11.4 Storms & flooding
    - 11.5 Other impacts
 
- **12 Other options**
    - 12.1 Other threat
:::

:::{.callout-note collapse="true"}

## *Esquema de Classificação de Ameaças* (tradução do inglês)

- **1. Desenvolvimento residencial e comercial**  
    - 1.1 Habitação e áreas urbanas  
    - 1.2 Áreas comerciais e industriais  
    - 1.3 Áreas de turismo e recreação  

- **2. Agricultura e aquicultura**  
    - 2.1 Culturas anuais e perenes não madeireiras  
        - 2.1.1 Agricultura itinerante  
        - 2.1.2 Agricultura de pequenos produtores  
        - 2.1.3 Agricultura agroindustrial  
        - 2.1.4 Escala desconhecida/não registrada  
    - 2.2 Plantações de madeira e celulose  
        - 2.2.1 Plantações de pequenos produtores  
        - 2.2.2 Plantações agroindustriais  
        - 2.2.3 Escala desconhecida/não registrada  
    - 2.3 Pecuária e criação de animais  
        - 2.3.1 Pastoreio nômade  
        - 2.3.2 Pastoreio, criação ou agricultura de pequenos produtores  
        - 2.3.3 Pastoreio, criação ou agricultura agroindustrial  
        - 2.3.4 Escala desconhecida/não registrada  
    - 2.4 Aquicultura marinha e de água doce  
        - 2.4.1 Aquicultura de subsistência/artesanal  
        - 2.4.2 Aquicultura industrial  
        - 2.4.3 Escala desconhecida/não registrada  

- **3. Produção de energia e mineração**  
    - 3.1 Perfuração de petróleo e gás  
    - 3.2 Mineração e extração de pedras  
    - 3.3 Energia renovável  

- **4. Corredores de transporte e serviços**  
    - 4.1 Estradas e ferrovias  
    - 4.2 Linhas de utilidades e serviços  
    - 4.3 Rotas de navegação  
    - 4.4 Rotas aéreas  

- **5. Uso de recursos biológicos**  
    - 5.1 Caça e coleta de animais terrestres  
        - 5.1.1 Uso intencional (espécie avaliada é o alvo)  
        - 5.1.2 Efeitos não intencionais (espécie avaliada não é o alvo)  
        - 5.1.3 Perseguição/controle  
        - 5.1.4 Motivação desconhecida/não registrada  
    - 5.2 Coleta de plantas terrestres  
        - 5.2.1 Uso intencional (espécie avaliada é o alvo)  
        - 5.2.2 Efeitos não intencionais (espécie avaliada não é o alvo)  
        - 5.2.3 Perseguição/controle  
        - 5.2.4 Motivação desconhecida/não registrada  
    - 5.3 Extração de madeira e produtos florestais  
        - 5.3.1 Uso intencional: subsistência/pequena escala (espécie avaliada é o alvo)  
        - 5.3.2 Uso intencional: grande escala (espécie avaliada é o alvo)  
        - 5.3.3 Efeitos não intencionais: subsistência/pequena escala (espécie avaliada não é o alvo)  
        - 5.3.4 Efeitos não intencionais: grande escala (espécie avaliada não é o alvo)  
        - 5.3.5 Motivação desconhecida/não registrada  
    - 5.4 Pesca e extração de recursos aquáticos  
        - 5.4.1 Uso intencional: subsistência/pequena escala (espécie avaliada é o alvo)  
        - 5.4.2 Uso intencional: grande escala (espécie avaliada é o alvo)  
        - 5.4.3 Efeitos não intencionais: subsistência/pequena escala (espécie avaliada não é o alvo)  
        - 5.4.4 Efeitos não intencionais: grande escala (espécie avaliada não é o alvo)  
        - 5.4.5 Perseguição/controle  
        - 5.4.6 Motivação desconhecida/não registrada  

- **6. Intrusões humanas e perturbações**  
    - 6.1 Atividades recreativas  
    - 6.2 Guerra, distúrbios civis e exercícios militares  
    - 6.3 Trabalho e outras atividades  

- **7. Modificações nos sistemas naturais**  
    - 7.1 Fogo e supressão de fogo  
        - 7.1.1 Aumento na frequência/intensidade do fogo  
        - 7.1.2 Redução na frequência/intensidade do fogo  
        - 7.1.3 Tendência desconhecida/não registrada  
    - 7.2 Barragens e gestão/uso da água  
        - 7.2.1 Captação de água superficial (uso doméstico)  
        - 7.2.2 Captação de água superficial (uso comercial)  
        - 7.2.3 Captação de água superficial (uso agrícola)  
        - 7.2.4 Captação de água superficial (uso desconhecido)  
        - 7.2.5 Captação de água subterrânea (uso doméstico)  
        - 7.2.6 Captação de água subterrânea (uso comercial)  
        - 7.2.7 Captação de água subterrânea (uso agrícola)  
        - 7.2.8 Captação de água subterrânea (uso desconhecido)  
        - 7.2.9 Pequenas barragens  
        - 7.2.10 Grandes barragens  
        - 7.2.11 Barragens (tamanho desconhecido)  
    - 7.3 Outras modificações dos ecossistemas  

- **8. Espécies invasoras e outros organismos problemáticos, genes e doenças**  
    - 8.1 Espécies/doenças invasoras exóticas/alóctones  
        - 8.1.1 Espécies não especificadas  
        - 8.1.2 Espécies nomeadas  
    - 8.2 Espécies/doenças nativas problemáticas  
        - 8.2.1 Espécies não especificadas  
        - 8.2.2 Espécies nomeadas  
    - 8.3 Material genético introduzido  
    - 8.4 Espécies/doenças problemáticas de origem desconhecida  
        - 8.4.1 Espécies não especificadas  
        - 8.4.2 Espécies nomeadas  
    - 8.5 Doenças virais/priónicas  
        - 8.5.1 “Espécies” (doenças) não especificadas  
        - 8.5.2 “Espécies” (doenças) nomeadas  
    - 8.6 Doenças de causa desconhecida  

- **9. Poluição**  
    - 9.1 Efluentes domésticos e urbanos  
        - 9.1.1 Esgoto  
        - 9.1.2 Escoamento superficial  
        - 9.1.3 Tipo desconhecido/não registrado  
    - 9.2 Efluentes industriais e militares  
        - 9.2.1 Vazamentos de óleo  
        - 9.2.2 Vazamentos de mineração  
        - 9.2.3 Tipo desconhecido/não registrado  
    - 9.3 Efluentes da agricultura e silvicultura  
        - 9.3.1 Carga de nutrientes  
        - 9.3.2 Erosão do solo, sedimentação  
        - 9.3.3 Herbicidas e pesticidas  
        - 9.3.4 Tipo desconhecido/não registrado  
    - 9.4 Lixo e resíduos sólidos  
    - 9.5 Poluentes atmosféricos  
        - 9.5.1 Chuva ácida  
        - 9.5.2 Névoa fotoquímica (smog)  
        - 9.5.3 Ozônio  
        - 9.5.4 Tipo desconhecido/não registrado  
    - 9.6 Excesso de energia  
        - 9.6.1 Poluição luminosa  
        - 9.6.2 Poluição térmica  
        - 9.6.3 Poluição sonora  
        - 9.6.4 Tipo desconhecido/não registrado  

- **10. Eventos geológicos**  
    - 10.1 Vulcões  
    - 10.2 Terremotos/tsunamis  
    - 10.3 Avalanches/deslizamentos  

- **11. Mudanças climáticas e eventos climáticos severos**  
    - 11.1 Mudança e alteração de habitat  
    - 11.2 Secas  
    - 11.3 Extremos de temperatura  
    - 11.4 Tempestades e inundações  
    - 11.5 Outros impactos  

- **12. Outras opções**  
    - 12.1 Outras ameaças  
:::

## Aplicação dos Critérios

​O pacote `ConR` [Dalby & Lima, 2023](https://gdauby.github.io/ConR/) para {{< fa brands r-project >}} é uma ferramenta desenvolvida para auxiliar na avaliação preliminar do status de conservação de espécies, seguindo os critérios da Lista Vermelha da IUCN. 

Criado por Gilles Dauby e Renato A. F. de Lima, o `ConR` permite análises em larga escala, facilitando o processamento de dados de múltiplas espécies simultaneamente.​

Executar os exemplos trazidos pelo `ConR` é uma ótima maneira de simular a aplicação dos critérios.

### Critério `A`

O critério `A` foi estabelecido para investigar o risco de extinção associado à táxons que **sofreram redução populacional significativa no passado próximo, ou que sofrerão redução populacional projetada no futuro próximo**.

Objetivamente, o critério `A` baseia-se exclusivamente em parâmetros relacionados à redução da população verificada ao longo de uma determinada escala temporal.

A lógica subjacente ao critério `A` é que todas as espécies têm igualmente maior probabilidade de extinção quando a taxa de declínio populacional é alta. 

Se a causa do declínio não é interrompida, a população será extinta, independentemente do tamanho populacional. Mesmo que uma população não esteja atualmente em declínio, a mesma ameaça pode voltar a afetá-la no futuro. Se um certa ameaça é capaz de causar um declínio acentuado, o mesmo declínio pode ocorrer como resposta a essa ameaça.

O critério `A` considera apenas a redução, pois quando uma população está diminuindo a uma taxa substancial, o risco de extinção é mais sensível à taxa de declínio do que ao tamanho da população.

Existem muitos exemplos de espécies abundantes que se tornaram extintas ou quase extintas. Essas espécies poderiam ter sido identificadas como ameaçadas apenas por um critério baseado apenas em declínios

Assim, tanto do ponto de vista prático quanto teórico, é necessário ter um critério baseado apenas na taxa de declínio, além de um que se baseie tanto no tamanho da população quanto na taxa de declínio (critério `C`).

#### Exercício de simulação

```{r}
#| warning: false

library(ConR)

data(example_criterionA)

criterion_A(example_criterionA,
    years = seq(1970, 2000, by = 2),
    assess.year = 2000,
    project.years = seq(2002, 2030, by = 2),
    subcriteria = c("A1", "A2", "A3", "A4"),
    generation.time = 10
)
```

Mesmos dados e opções, mas **assumindo comprimentos de geração diferentes** para cada táxon:

```{r}
#| warning: false

library(ConR)

data(example_criterionA)

criterion_A(example_criterionA,
    years = seq(1970, 2000, by = 2),
    assess.year = 2000,
    project.years = seq(2002, 2030, by = 2),
    subcriteria = c("A1", "A2", "A3", "A4"),
    generation.time = c(2, 5, 10, 15, 30, 50) # comprimentos de geração diferentes
) 
```

Avaliando se três espécies brasileiras de plantas (*Araucaria angustifolia*, *Euterpe edulis* e *Paubrasilia echinata*) sofreram redução populacional nas últimas 3 gerações (Subcritério `A2`), e em que grau, com base em estimativas de tamanho populacional ao longo do tempo.

```{r}
#| warning: false

# Carrega o pacote ConR, utilizado para avaliações preliminares do risco de extinção
library(ConR)

# Vetor com os nomes das espécies a serem avaliadas
spp <- c("Araucaria angustifolia", "Euterpe edulis", "Paubrasilia echinata")

# Define o número de espécies (número de linhas na matriz futura)
nrows <- length(spp)

# Carrega dados de exemplo do pacote ConR
data(example_tutorial)

# Extrai a tabela de tamanhos populacionais do conjunto de dados
pop.sizes <- example_tutorial$population.sizes

# Visualiza as primeiras linhas dos dados de tamanho populacional
head(pop.sizes)

# Estima os tamanhos populacionais para os anos ausentes, com base nas tendências
est.pop.sizes <- pop.decline(pop.sizes[, -1], # Remove a primeira coluna (nomes dos táxons)
    taxa = spp, # Vetor de nomes das espécies
    output = "predictions", # Solicita as previsões de tamanho
    show_progress = FALSE
) # Não exibe a barra de progresso

# Extrai os anos dos dados previstos (serão usados como nomes das colunas)
new.years <- est.pop.sizes[[1]][[1]]$years

# Define o número de colunas da matriz (um para cada ano previsto)
ncols <- length(new.years)

# Cria uma matriz vazia com os nomes das espécies nas linhas e anos nas colunas
mean.pop <- matrix(NA, ncol = ncols, nrow = nrows, dimnames = list(spp, new.years))

# Preenche a matriz com os tamanhos populacionais previstos para cada espécie
for (i in seq_along(spp)) {
    mean.pop[i, ] <- est.pop.sizes[[1]][[i]]$predicted
}

# Converte a matriz em data frame e adiciona uma coluna com os nomes das espécies
mean.pop <- cbind.data.frame(tax = spp, mean.pop, row.names = NULL)

# Define o ano da avaliação (ano de referência para projeções e status)
assess.year <- 2018

# Define os comprimentos de geração (em anos) para cada espécie
gen.length <- c(40, 65, 50)

# Define os níveis de exploração (percentual de redução populacional por extração/uso)
harvest <- c(10, 10, 10)

# Executa a avaliação do Critério A da IUCN (subcritério A2)
critA <- criterion_A(
    x = mean.pop, # Dados de população ao longo do tempo
    assess.year = assess.year, # Ano de avaliação
    project.years = NULL, # Sem projeções adicionais para o futuro
    subcriteria = c("A2"), # Subcritério A2: redução passada
    generation.time = gen.length, # Comprimento de geração para cada espécie
    exploitation = harvest, # Pressão de exploração estimada
    show_progress = FALSE # Não exibe barra de progresso
)
critA
```

### Critério `B`

O critério `B` foi estabelecido para investigar o risco de extinção associado à táxons que apresentam distribuição restrita e/ou especificidade de habitat expressos através de seus valores de EOO e AOO. E que além disso, também apresentam pelo menos duas das três condições (`(a)`, `(b)` e `(c)`). Se apenas uma condição é atendida, não é possível categorizar o táxon sob o criterio `B`. Essas condições referem-se a fragmentação severa ou número de situações de ameaças, declínio contínuo observado, estimado ou projetado em EOO, AOO, área, extensão e/ou qualidade do habitat, no número de situações de ameaça ou e no número de indivíduos maduros.

A condição `(a)` requer fragmentação severa e/ou número limitado de situações de ameaças. A IUCN recomenda que os avaliadores especifique explicitamente em sua documentação: 

1. Se o táxon está gravemente fragmentado; e 
2. O número de localizações condicionadas à ameaça.

A condição `(c)` requer que a flutuação seja extrema em qualquer dos parâmetros (subcondições): 

- `(i)` EOO; 
- `(ii)` AOO; 
- `(iii)` número de situações de ameaças ou subpopulações; e 
- `(iv)` número de indivíduos maduros.

```{r}
#| warning: false

library(ConR)

data(example_tutorial)
occs <- example_tutorial$occurrences
head(occs, 2)

AOO <- AOO.computing(occs[, c(1:3)],
    cell_size_AOO = 2, nbe.rep.rast.AOO = 30,
    show_progress = FALSE
)

EOO.hull <- EOO.computing(
    XY = occs[, c(1:3)], method.range = "convex.hull",
    export_shp = TRUE, show_progress = FALSE
)

locs <- locations.comp(occs[, c(1:3), ],
    method = "fixed_grid",
    nbe_rep = 30,
    cell_size_locations = 10,
    rel_cell_size = 0.05,
    method_polygons = "no_more_than_one",
    show_progress = FALSE
)

radius <- subpop.radius(
    XY = occs[, c(1:3)],
    quant.max = 0.9
)

sub <- subpop.comp(
    XY = occs[, c(1:3)],
    resol_sub_pop = radius[, c("tax", "radius")],
    show_progress = FALSE
)

sever.frag <- severe_frag(
    XY = occs,
    resol_sub_pop = radius[, c("tax", "radius")],
    dist_isolated = radius$radius,
    show_progress = FALSE
)

rel.loss <- c(8.5, 8.1, 9.0)
declineB <- ifelse(rel.loss >= 1, "Decreasing", "Not Decreasing")

critB <- criterion_B(
    x = occs,
    AOO = AOO,
    EOO = EOO.hull$results,
    locations = locs$locations,
    severe.frag = sever.frag,
    subpops = sub,
    decline = declineB,
    show_progress = FALSE
)
critB
```


### Critério `C`

O critério `C` foi estabelecido para investigar o risco de extinção associado a táxons que apresentam **população global pequena e em declínio**. Assim, o **número de indivíduos maduros da população global é uma informação fundamental** para acessar esse critério, que também demanda dados sobre **declínio contínuo no número de indivíduos maduros** em um dado tempo ou número de geração na qual o declínio de indivíduos maduros foi verificado. 

Além disso, o **número de indivíduos maduros em cada subpopulação** (valor absoluto N), a **proporção (%) de indivíduos maduros** situadas em uma dada subpopulação conhecida de um táxon específico e **flutuações extremas** no número de indivíduos maduros completam o conjunto de subcritérios que caracterizam o critério `C`.

```{r}
#| warning: false

library(ConR)

# Vetor com os nomes das espécies a serem avaliadas
spp <- c("Araucaria angustifolia", "Euterpe edulis", "Paubrasilia echinata")

# Define o número de espécies (número de linhas na matriz futura)
nrows <- length(spp)

# Carrega dados de exemplo do pacote ConR
data(example_tutorial)
occs <- example_tutorial$occurrences # Dados de ocorrência geográfica das espécies

# Extrai a tabela de tamanhos populacionais do conjunto de dados
pop.sizes <- example_tutorial$population.sizes

# Visualiza as primeiras linhas dos dados de tamanho populacional
head(pop.sizes)

# Estima os tamanhos populacionais para os anos ausentes, com base nas tendências observadas
est.pop.sizes <- pop.decline(pop.sizes[, -1], # Remove a primeira coluna (nomes das espécies)
    taxa = spp, # Vetor de nomes das espécies
    output = "predictions", # Solicita previsões de tamanho populacional
    show_progress = FALSE
) # Não exibe barra de progresso

# Extrai os anos dos dados previstos (esses serão os nomes das colunas da matriz)
new.years <- est.pop.sizes[[1]][[1]]$years

# Define o número de colunas da matriz (um para cada ano previsto)
ncols <- length(new.years)

# Cria uma matriz vazia com as espécies como linhas e os anos como colunas
mean.pop <- matrix(NA, ncol = ncols, nrow = nrows, dimnames = list(spp, new.years))

# Preenche a matriz com os valores de tamanho populacional previstos para cada espécie
for (i in seq_along(spp)) {
    mean.pop[i, ] <- est.pop.sizes[[1]][[i]]$predicted
}

# Converte a matriz em um data frame e adiciona uma coluna com os nomes das espécies
mean.pop <- cbind.data.frame(tax = spp, mean.pop, row.names = NULL)

# --------------------------
# CÁLCULO DE SUBPOPULAÇÕES
# --------------------------

# Calcula o raio médio de dispersão das ocorrências para estimar a separação entre subpopulações
radius <- subpop.radius(
    XY = occs[, c(1:3)], # Dados espaciais: táxon, longitude, latitude
    quant.max = 0.9
) # Usa o percentil 90 para definir o raio

# Usa os raios calculados para estimar o número de subpopulações por espécie
sub <- subpop.comp(
    XY = occs[, c(1:3)],
    resol_sub_pop = radius[, c("tax", "radius")],
    show_progress = FALSE
)

# --------------------------
# PARÂMETROS PARA O CRITÉRIO C
# --------------------------

# Define o ano da avaliação
assess.year <- 2018

# Define o ano mais recente com dados confiáveis
recent.year <- 2000

# Comprimento da geração (em anos) para cada espécie
gen.length <- c(40, 65, 50)

# Proporção de indivíduos maduros na população de cada espécie
p.mature <- c(0.4485, 0.3028, 0.4143)

# Correção aplicada ao declínio populacional para espécies de sucessão precoce
early.sucession <- c(0.9, 1, 1)

# --------------------------
# CÁLCULO DO TAMANHO DE CADA SUBPOPULAÇÃO
# --------------------------

# Identifica a coluna referente ao ano da avaliação (2018) no data frame
id.assess <- which(names(mean.pop) %in% assess.year)

# Junta os tamanhos populacionais do ano da avaliação com o número de subpopulações
df <- merge(data.frame(tax = spp, "2018" = mean.pop[, id.assess]), sub)

# Cria uma lista onde cada elemento representa as subpopulações de uma espécie
# Cada subpopulação recebe um valor igual (dividindo a população total pelo número de subpopulações)
subpop.sizes <- vector("list", dim(sub)[1])
names(subpop.sizes) <- sub$tax
for (i in seq_along(subpop.sizes)) {
    subpop.sizes[[i]] <- rep(df$X2018[i] / df$subpop[i], df$subpop[i])
}

# --------------------------
# APLICA O CRITÉRIO C DA IUCN
# --------------------------

# Executa a avaliação de risco com base no Critério C (população pequena e em declínio)
critC <- criterion_C(
    x = mean.pop, # Tamanhos populacionais ao longo dos anos
    assess.year = assess.year, # Ano da avaliação
    project = FALSE, # Não projeta tendências futuras
    recent.year = recent.year, # Ano mais recente considerado confiável
    subcriteria = c("C1", "C2"), # Subcritérios C1 e C2
    generation.time = gen.length, # Comprimento da geração por espécie
    prop.mature = p.mature, # Proporção de indivíduos maduros
    subpop.size = subpop.sizes, # Tamanhos das subpopulações
    correction = early.sucession, # Correção aplicada ao declínio
    show_progress = FALSE
)
critC
```

### Critério `D`

O critério `D` se destina a avaliar táxons que possuam populações muito pequenas ou restritas. Para acessar esse critério, são necessários dados referentes ao número de indivíduos maduros (`D` ou `D1`) ou então, a espécie precisa apresentar AOO restrita (AOO < 20 km²) ou pequeno número de situções de ameaça (menor ou igual a 5), além de incidência de ameaça plausível que irá levá-la a uma categoria de ameaça mais restritiva (`CR` ou `EX`) no futuro próximo (`VU D2`).

```{r}
#| warning: false

# Carrega o pacote ConR, que permite calcular critérios da IUCN para avaliação de risco de extinção
library(ConR)

# Proporção de indivíduos maduros na população para cada espécie
p.mature <- c(0.4485, 0.3028, 0.4143)

# Nível de exploração (em %) para cada espécie comercial — utilizado para corrigir a proporção de indivíduos maduros
harvest <- c(10, 10, 10)

# Corrige a proporção de indivíduos maduros com base na exploração (reduz o valor conforme o nível de exploração)
p.mature.explo <- p.mature - harvest / 100

# Vetor com os nomes das espécies a serem avaliadas
spp <- c("Araucaria angustifolia", "Euterpe edulis", "Paubrasilia echinata")

# Número de espécies
nrows <- length(spp)

# Carrega dados de exemplo do pacote ConR
data(example_tutorial)
occs <- example_tutorial$occurrences # Dados de ocorrência das espécies

# Extrai a tabela de tamanhos populacionais do conjunto de dados
pop.sizes <- example_tutorial$population.sizes

# Visualiza as primeiras linhas dos dados de tamanho populacional
head(pop.sizes)

# Estima os tamanhos populacionais ao longo dos anos, com base em tendências temporais
est.pop.sizes <- pop.decline(pop.sizes[, -1], # Remove a primeira coluna (nomes dos táxons)
    taxa = spp, # Vetor com nomes das espécies
    output = "predictions", # Solicita apenas as previsões de tamanho
    show_progress = FALSE
) # Desativa exibição de progresso

# Extrai os anos incluídos nas previsões (serão usados como nomes das colunas)
new.years <- est.pop.sizes[[1]][[1]]$years

# Número de colunas da matriz final (corresponde ao número de anos previstos)
ncols <- length(new.years)

# Cria uma matriz para armazenar os tamanhos populacionais médios para cada espécie e ano
mean.pop <- matrix(NA, ncol = ncols, nrow = nrows, dimnames = list(spp, new.years))

# Preenche a matriz com os valores previstos
for (i in seq_along(spp)) {
    mean.pop[i, ] <- est.pop.sizes[[1]][[i]]$predicted
}

# Converte a matriz em data frame e adiciona a coluna com os nomes das espécies
mean.pop <- cbind.data.frame(tax = spp, mean.pop, row.names = NULL)

# Seleciona os tamanhos populacionais para o ano da avaliação (coluna 18 corresponde ao ano de 2018)
pop.sizes.assess <- mean.pop[[18]]

# Calcula a Área de Ocorrência (AOO) usando uma malha de 2 km x 2 km e 30 repetições
AOO <- AOO.computing(occs[, c(1:3)],
    cell_size_AOO = 2,
    nbe.rep.rast.AOO = 30,
    show_progress = FALSE
)

# Calcula o número de localidades (locations), baseado em critérios espaciais definidos pela IUCN
locs <- locations.comp(occs[, c(1:3)],
    nbe_rep = 30,
    cell_size_locations = 10,
    rel_cell_size = 0.05,
    id_shape = "NAME",
    method_polygons = "no_more_than_one",
    show_progress = TRUE
)

# Avalia o Critério D da IUCN, considerando população, AOO e número de localidades
critD <- criterion_D(
    pop.size = pop.sizes.assess, # Tamanho da população no ano de avaliação
    name_sp = mean.pop[[1]], # Nomes das espécies
    AOO = AOO$aoo, # Área de Ocorrência estimada
    n.Locs = locs$locations$locations, # Número de localidades
    prop.mature = p.mature.explo, # Proporção de indivíduos maduros (corrigida pela exploração)
    subcriteria = c("D", "D2"), # Subcritérios a serem avaliados
    AOO.threshold = 20, # Limite de AOO (em km²) para subcritério D2
    Loc.threshold = 5 # Limite de localidades para subcritério D2
) 
critD
```